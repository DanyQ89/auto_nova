<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% extends "base.html" %}
    {% block styles %}
    <link rel="stylesheet" href="../static/css/basket.css"> <!-- Подключаем CSS для блока content -->
    {% endblock %}
    <title>Корзина</title>
<!--    <link rel="stylesheet" href="../static/css/basket.css">-->
</head>
<body>
{% block content %}
    <div id="menu" class="menu">
        <a href="./">На главную</a>
        <a href="./contacts">Контакты</a>
        <a href="./guarantees">Гарантии</a>
        <a href="#" onclick="toggleMenu()">Закрыть меню</a>
    </div>
    <h1>Корзина</h1>

    <table>
        <thead>
            <tr>
                <th>Артикул</th>
                <th>Марка</th>
                <th>Модель</th>
                <th>Наименование</th>
                <th>Цена</th>
                <th>Цена по карте</th>
                <th>Фото</th>
                <th>Итого</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody id="cartItems">
            {% for detail in details %}
            <tr data-detail-ID_detail="{{ detail.ID_detail }}">
                <td>{{ detail.ID_detail }}</td>
                <td>{{ detail.brand }}</td>
                <td>{{ detail.model_and_year }}</td>
                <td>{{ detail.name }}</td>
                <td>{{ detail.price }} руб.</td>
                <td>{{ detail.price_w_discount }} руб.</td>
                <td><img src="{{ detail.photo }}" alt="Фото" style="width: 50px; height: auto;"></td>
                <td>{{ detail.price }} руб.</td> <!-- Или используйте другую логику для расчета -->
                <td><button onclick="removeFromBasket('{{ detail.ID_detail }}')">Удалить</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p id="total">Итого: {{ total_price }} руб.</p>
    <p id="totalCard">Итого по карте: {{ total_card_price }} руб.</p>

    <button id="checkoutButton">Оформить заказ</button>
    <script>
        async function removeFromBasket(detailId) {
            alert("meow")
            try {
                const response = await fetch(`/remove_from_basket/${detailId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // Выводим состояние response в консоль
                alert('Response:', response.ok);

                if (response.ok) {
                    alert("meow meow")
                    const data = await response.json();
                    alert("have response.json");

                    // Найдите строку таблицы, соответствующую удаляемой детали
                    const row = document.querySelector(`tr[data-detail-ID_detail="${detailId}"]`);
                    alert(`Row found: ${row}`); // Исправлено на обратные кавычки// Выводим состояние row в консоль

                    if (row) {
                        row.remove(); // Удалите строку из таблицы
                        alert(`Row with detail ID ${detailId} removed from table.`); // Исправлено на обратные кавычки
                        console.log(`Row with detail ID ${detailId} removed from table.`);
                    }

                    // Обновите итоговые суммы
                    updateTotals();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Произошла ошибка при удалении детали из корзины.');
                }
            } catch (error) {
                console.error('Ошибка при удалении детали из корзины:', error);
                alert('Произошла ошибка при удалении детали из корзины.');
            }
        }

        // Функция для обновления итоговых сумм
        function updateTotals() {
            let total = 0;
            let totalCard = 0;

            // Переберите все строки таблицы и пересчитайте суммы
            const rows = document.querySelectorAll('#cartItems tr');
            rows.forEach(row => {
                const price = parseFloat(row.querySelector('td:nth-child(5)').innerText) || 0; // Цена
                const priceCard = parseFloat(row.querySelector('td:nth-child(6)').innerText) || 0; // Цена по карте
                total += price;
                totalCard += priceCard;
            });

            document.getElementById('total').innerText = `Итого: ${total} руб.`;
            document.getElementById('totalCard').innerText = `Итого по карте: ${totalCard} руб.`;
        }

        // Обработчик события blur для ячеек таблицы
        document.getElementById('cartItems').addEventListener('blur', function(e) {
            if (e.target.tagName === 'TD' && e.target.innerHTML.trim() === '') {
                const row = e.target.parentNode; // Получаем родительскую строку
                row.remove(); // Удаляем строку, если ячейка пустая
                updateTotals(); // Обновляем итоговые суммы
            }
        }, true);
    </script>
{% endblock %}
</body>
</html>